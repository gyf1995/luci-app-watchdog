name: Build luci-app-watchdog for x86

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git wget

    # ---------------------------
    # Download OpenWrt SDK (x86)
    # ---------------------------
    - name: Download SDK
      run: |
        wget https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-sdk-23.05.3-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        sdk_dir=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*")
        mv "$sdk_dir" sdk

    # ---------------------------
    # Move your package to SDK
    # ---------------------------
    - name: Prepare package
      run: |
        mkdir -p sdk/package/luci-app-watchdog
        cp -r luci-app-watchdog/* sdk/package/luci-app-watchdog/

    # ---------------------------
    # Build the IPK
    # ---------------------------
    - name: Build package
      run: |
        cd sdk
        make defconfig
        make package/luci-app-watchdog/compile -j$(nproc) V=s

    # ---------------------------
    # Upload artifacts (v4)
    # ---------------------------
    - name: Upload IPK
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-watchdog_x86
        path: |
          sdk/bin/packages/**/luci-app-watchdog*.ipk
          sdk/bin/targets/**/luci-app-watchdog*.ipk
